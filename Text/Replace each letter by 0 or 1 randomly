(() => {
  // Tags to ignore
  const SKIP_TAGS = new Set(['SCRIPT','STYLE','NOSCRIPT','TEXTAREA','INPUT','IFRAME','CANVAS','SELECT','OPTION']);
  // Stockage des originaux (WeakMap pour éviter fuites mémoire)
  const originalMap = new WeakMap();

  // Function that transforms text but keeps spaces and line breaks and replaces the rest with random 0/1
  const toBinary = txt => txt.replace(/[^\n\r ]/g, () => (Math.random() < 0.5 ? '0' : '1'));

  // TreeWalker to traverse all the text nodes of the body
  const walker = document.createTreeWalker(
    document.body,
    NodeFilter.SHOW_TEXT,
    {
      acceptNode(node) {
        // if there is no parent or it is just space/line break -> ignore
        const parent = node.parentElement;
        if (!parent) return NodeFilter.FILTER_REJECT;
        // ignorer certaines balises
        if (SKIP_TAGS.has(parent.tagName)) return NodeFilter.FILTER_REJECT;
        // ignorer les zones éditables pour éviter de casser des éditeurs
        if (parent.isContentEditable) return NodeFilter.FILTER_REJECT;
        // si le texte est uniquement des espaces/newlines, rien à faire
        if (!/[^\n\r ]/.test(node.nodeValue)) return NodeFilter.FILTER_REJECT;
        return NodeFilter.FILTER_ACCEPT;
      }
    },
    false
  );

  // Collecting nodes do not modify during iteration
  const textNodes = [];
  while (walker.nextNode()) textNodes.push(walker.currentNode);

  // apply the transformation and save the original
  textNodes.forEach(n => {
    if (!originalMap.has(n)) originalMap.set(n, n.nodeValue);
    n.nodeValue = toBinary(n.nodeValue);
  });

  // Provide a restore function accessible through the console but idk if that's useful 
  window.__restoreBinaryText = () => {
    try {
      textNodes.forEach(n => {
        if (originalMap.has(n)) n.nodeValue = originalMap.get(n);
      });
      // optional cleaning and again idk if that's useful lol
      delete window.__restoreBinaryText;
      console.log('Texte restauré à l\'original.');
    } catch (e) {
      console.error('Erreur lors de la restauration :', e);
    }
  };

  console.log('Conversion complete. To restore the original text, type : window.__restoreBinaryText()');
})();
